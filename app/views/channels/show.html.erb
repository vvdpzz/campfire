<div id="chatOuter">
	<div id="chat">
		<%= render :partial => "partials/message",
							 :collection => @channel.messages_from_redis %>
	</div>
</div>
<div id="docs">
	<div class="fluploader_wrapper">
		<label class="fluploader_select uiButton">
			<input value="选择文件" type="submit">
		</label>
		<div class="fluploader_swfdiv">
			<input id="uploadify" name="uploadify" type="file" />
		</div>
	</div>
</div>

<%= form_tag({:controller => 'messages', :action => 'create'}, :remote => true, :id => 'new_message') do %>
	<%= hidden_field :channel_id, @channel.id %>
  <%= text_area_tag :body, {}, :class => "message_box" %>
<% end %>

<script>
	$(document).ready(function() {
			$('body').scrollTop($('body')[0].scrollHeight);
			
			<% key = Rails.application.config.session_options[:key] %>
			var uploadify_script_data = {};
			var csrf_param = $('meta[name=csrf-param]').attr('content');
			var csrf_token = $('meta[name=csrf-token]').attr('content');
			uploadify_script_data[csrf_param] = encodeURI(encodeURIComponent(csrf_token));
			uploadify_script_data['<%= key %>'] = '<%= cookies[key] %>';
			uploadify_script_data['channel_id'] = "<%= @channel.id %>";

			$('#uploadify').uploadify({
				uploader  		: '/assets/uploadify.swf',
				script    		: '/docs',
				cancelImg		: '/images/cancel.png',
				auto			: true,
				multi			: true,
				removeCompleted : true,
				scriptData		: uploadify_script_data,
				wmode			: "transparent",
				hideButton		: true,
				height			: 20,
				width			: 58,
				queueID			: 'photos_Queue',
				onComplete		: function(event, ID, fileObj, response, data) {
					response = eval('(' + response + ')');
					alert("OK");
				}
			});
	});
	var pusher = new Pusher('2f20b4687fdaada149b2');
	var c = pusher.subscribe("channel_<%= @channel.id %>");
	c.bind('message-create', function(message) {
		if (message.uid != "<%= current_user.id %>"){
			$("#chat").append("<div id='message_'" + message.id + " class='message other'><div class='person'>"+message.name+"</div><div class='body'>"+message.body+"</div></div>");
			$('body').scrollTop($('body')[0].scrollHeight);
		}
	});
	
	
	$("#new_message").keypress(function(event) {
		if (event.keyCode == '13') {
			event.preventDefault();
			textarea = document.getElementById("body");
			if (textarea.value.trim() != ''){
				$('#chat').append("<div class='message self'><div class='person'><%= current_user.username %></div><div class='body'>"+textarea.value+"</div></div>");
				$('body').scrollTop($('body')[0].scrollHeight);
				
				var value = $("#new_message").serialize();
				$("#new_message")[0].reset();
				$.post("/messages", value);
			}
		}
	});
</script>
