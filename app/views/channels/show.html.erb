<p id="notice"><%= notice %></p>

<p>
  <b>Name:</b>
  <%= @channel.name %>
</p>

<div id="chatOuter">
	<div id="chat">
		<%= render :partial => "partials/message",
							 :collection => @channel.messages_from_redis %>
	</div>
</div>

<%= form_tag({:controller => 'messages', :action => 'create'}, :remote => true, :id => 'new_message') do %>
	<%= hidden_field :channel_id, @channel.id %>
  <%= text_area_tag :body, {}, :class => "message_box" %>
<% end %>

<script>
	var pusher = new Pusher('2f20b4687fdaada149b2');
	var c = pusher.subscribe("channel_<%= @channel.id %>");
	c.bind('message-create', function(message) {
		if (message.uid != "<%= current_user.id %>"){
			$("#chat").append("<div id='message_'" + message.id + " class='message other'><div class='person'>"+message.name+"</div><div class='body'>"+message.body+"</div></div>");
			$('body').scrollTop($('body')[0].scrollHeight);
		}
	});
	
	
	$("#new_message").keypress(function(event) {
		if (event.keyCode == '13') {
			event.preventDefault();
			textarea = document.getElementById("body");
			if (textarea.value.trim() != ''){
				$('#chat').append("<div class='message self'><div class='person'><%= current_user.username %></div><div class='body'>"+textarea.value+"</div></div>");
				$('body').scrollTop($('body')[0].scrollHeight);
				
				var value = $("#new_message").serialize();
				$("#new_message")[0].reset();
				$.post("/messages", value);
			}
		}
	});
</script>
